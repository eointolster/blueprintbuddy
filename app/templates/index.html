{% extends "base.html" %}

{% block title %}Home{% endblock %}

{% block content %}
<div class="workspace">
    <div class="canvas-container">
        <div class="canvas-toolbar">
            <button onclick="handleSave()" class="toolbar-button">
                <i class="fas fa-save"></i> Save Blueprint
            </button>
            <input type="file" id="loadFile" style="display: none" accept=".json" onchange="handleLoad(event)">
            <button onclick="document.getElementById('loadFile').click()" class="toolbar-button">
                <i class="fas fa-folder-open"></i> Load Blueprint
            </button>
        </div>
        <svg id="main-canvas"></svg>
    </div>
    <div class="sidebar">
        <div class="chat-container">
            <div class="chat-messages"></div>
            <div class="chat-input">
                <input type="text" id="chat-input" placeholder="Ask BlueprintBuddy...">
                <button id="send-message">Send</button>
                <button onclick="window.blueprintCanvas.testCreateComponent()">Test</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Make sure D3 is loaded first -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<!-- Load modular canvas components in order -->
<script src="{{ url_for('static', filename='js/modules/StateManager.js') }}"></script>
<script src="{{ url_for('static', filename='js/modules/PortManager.js') }}"></script>
<script src="{{ url_for('static', filename='js/modules/ComponentManager.js') }}"></script>
<script src="{{ url_for('static', filename='js/modules/ConnectionManager.js') }}"></script>
<script src="{{ url_for('static', filename='js/modules/UIManager.js') }}"></script>
<script src="{{ url_for('static', filename='js/modules/CanvasCore.js') }}"></script>

<!-- Add Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<!-- Initialize canvas and add save/load handlers -->
<script>
    function handleSave() {
        window.blueprintCanvas.saveToJson();
    }

    async function handleLoad(event) {
        const file = event.target.files[0];
        if (!file) return;

        try {
            // Validate file type
            if (!file.name.endsWith('.json')) {
                throw new Error('Invalid file type. Please select a JSON file.');
            }

            // Validate file size (max 10MB)
            const maxSize = 10 * 1024 * 1024;
            if (file.size > maxSize) {
                throw new Error('File too large. Maximum size is 10MB.');
            }

            // Validate file is not empty
            if (file.size === 0) {
                throw new Error('File is empty.');
            }

            await window.blueprintCanvas.loadFromJson(file);
        } catch (error) {
            console.error('Error loading blueprint:', error);
            alert(`Error loading blueprint: ${error.message}`);
        } finally {
            // Reset file input in finally block to ensure cleanup
            event.target.value = '';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Initialize canvas
        window.blueprintCanvas = new BlueprintCanvas();
    });
</script>

<!-- Add some CSS for the toolbar -->
<style>
    .canvas-toolbar {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 1000;
        display: flex;
        gap: 10px;
    }

    .toolbar-button {
        background-color: #37474f;
        color: #90a4ae;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background-color 0.2s;
    }

    .toolbar-button:hover {
        background-color: #455a64;
        color: #b0bec5;
    }

    .toolbar-button:active {
        background-color: #546e7a;
    }

    .toolbar-button i {
        font-size: 14px;
    }
</style>
{% endblock %}